<export><workspace name="geo-ip"><query name="Query 1" focus="false" active="true" content-source="14369746076098578715:0:Apps" mode="xquery">xquery version "1.0-ml";

import module namespace functx = "http://www.functx.com" at "/MarkLogic/functx/functx-1.0-nodoc-2007-01.xqy";

(: The goal is to do something like this: 
&lt;Response&gt;
&lt;IP&gt;92.26.223.198&lt;/IP&gt;
&lt;CountryCode&gt;GB&lt;/CountryCode&gt;
&lt;CountryName&gt;United Kingdom&lt;/CountryName&gt;
&lt;RegionCode/&gt;
&lt;RegionName/&gt;
&lt;City/&gt;
&lt;ZipCode/&gt;
&lt;TimeZone&gt;Europe/London&lt;/TimeZone&gt;
&lt;Latitude&gt;51.4964&lt;/Latitude&gt;
&lt;Longitude&gt;-0.1224&lt;/Longitude&gt;
&lt;MetroCode&gt;0&lt;/MetroCode&gt;
&lt;/Response&gt;
:)

(:
cts:search(doc(), cts:element-value-query(xs:QName("city_name"), "London"))
:)

declare variable $IPv4 as xs:string := "92.26.223.198";
declare variable $SEARCH-IP as xs:string := functx:substring-before-last($IPv4, '.');

declare function local:find-matching-ip-data($ipaddr as xs:string) as item()* {
  cts:search(doc(), cts:element-word-query(xs:QName("network"), functx:substring-before-last($ipaddr, '.')))
};

declare function local:nearest-match($items as item()*) {
  fn:root($items//accuracy_radius[. eq min($items//accuracy_radius) ]) 
   (: for $item in $items  
   where some $item in $items satisfies min($item//accuracy_radius)
   return $item :)
   
};

declare function local:get-geoname-by-id($id as xs:string) {
  cts:search(doc(), cts:element-value-query(xs:QName("geoname_id"), $id))
};

local:nearest-match(local:find-matching-ip-data($IPv4))//geoname_id



 </query><query name="Query 2" focus="false" active="true" content-source="14369746076098578715:0:Apps" mode="xquery">xquery version "1.0-ml";

for $i in cts:search(doc(), cts:element-value-query(xs:QName("geoname_id"), "2635167"))
return fn:local-name($i)</query><query name="Query 3" focus="false" active="true" content-source="14369746076098578715:0:Apps" mode="xquery">xquery version "1.0-ml";

import module namespace functx = "http://www.functx.com" at "/MarkLogic/functx/functx-1.0-nodoc-2007-01.xqy";

(: The goal is to do something like this: 
&lt;Response&gt;
&lt;IP&gt;92.26.223.198&lt;/IP&gt;
&lt;CountryCode&gt;GB&lt;/CountryCode&gt;
&lt;CountryName&gt;United Kingdom&lt;/CountryName&gt;
&lt;RegionCode/&gt;
&lt;RegionName/&gt;
&lt;City/&gt;
&lt;ZipCode/&gt;
&lt;TimeZone&gt;Europe/London&lt;/TimeZone&gt;
&lt;Latitude&gt;51.4964&lt;/Latitude&gt;
&lt;Longitude&gt;-0.1224&lt;/Longitude&gt;
&lt;MetroCode&gt;0&lt;/MetroCode&gt;
&lt;/Response&gt;
:)

(:
cts:search(doc(), cts:element-value-query(xs:QName("city_name"), "London"))
:)

declare variable $IPv4 as xs:string := "146.198.178.59";
declare variable $SEARCH-IP as xs:string := functx:substring-before-last($IPv4, '.');

declare function local:find-matching-ip-data($ipaddr as xs:string) as item()* {
  cts:search(doc(), cts:element-word-query(xs:QName("network"), functx:substring-before-last($ipaddr, '.')))
};

declare function local:nearest-match($items as item()*) {
  fn:root($items//accuracy_radius[. eq min($items//accuracy_radius) ]) 
   (: for $item in $items  
   where some $item in $items satisfies min($item//accuracy_radius)
   return $item :)
   
};

declare function local:get-geoname-by-id($id as xs:string) {
  cts:search(doc(), cts:element-value-query(xs:QName("geoname_id"), $id))
};

local:nearest-match(local:find-matching-ip-data($IPv4))



 

</query><query name="GMaps link" focus="true" active="true" content-source="14369746076098578715:0:Apps" mode="xquery">xquery version "1.0-ml";

declare function local:nearest-match($items as item()*) {
  fn:root($items//accuracy_radius[. eq min($items//accuracy_radius) ]) 
   (: for $item in $items  
   where some $item in $items satisfies min($item//accuracy_radius)
   return $item :)
   
};

declare function local:gmaps-link($item) {
  (:"http://maps.google.com/?q="||$item//latitude||","||$item//longitude :)
  "https://maps.googleapis.com/maps/api/staticmap?center="||$item//latitude||","||$item//longitude||"&amp;amp;zoom=13&amp;amp;size=300x300"
};

local:gmaps-link(local:nearest-match(cts:search(doc(), cts:element-value-query(xs:QName("network"), "146.198.*", "wildcarded"))))



</query></workspace></export>
